---
title: "MDS Knowledge Map"
format: 
  html:
    page-layout: full
---

## 1 Arbitrary Arrangement 

### Features:

- hover on a node to see course name
- hover on an edge to see the connecting concepts 
- click on a node to see all of its 'to' and 'from' connections
- use the dropdown below to select a course

```{r}
#| echo: false
#| message: false
#| warning: false

library(visNetwork)
library(dplyr)
library(readr)

# --- 1. THE READER ---
#' Load raw data from files
#'
#' @param nodes_path Path to nodes.csv file.
#' @param edges_path Path to edges.csv file.
#'
#' @return A list containing two data frames: nodes and edges.
read_map_data <- function(nodes_path, edges_path) {
  nodes <- read_csv(nodes_path, show_col_types = FALSE)
  edges <- read_csv(edges_path, show_col_types = FALSE)
  return(list(nodes = nodes, edges = edges))
}

# --- 2. THE TRANSFORMER ---
#' Converts grid coordinates into a pixel-based coordinate system 
#' and applies visual properties (colors, shapes, tooltips) to nodes and edges.
#'
#' @param data A list containing 'nodes' and 'edges' data frames.
#'
#' @return A list with modified data frames.
transform_map_data <- function(data) {
  data$nodes <- data$nodes %>%
    mutate(
      x = column * 250, 
      y = row * 150,
      
      label = label,
      title = name,
      shape = "box",
      color = I(list(list(
        background = "#D2E5FF", 
        border = "#2B7CE9",
        highlight = "#FFB347"
      ))),
      font = I(list(list(face = "Arial", size = 18))),
      shadow = TRUE,
      fixed = TRUE
    )
  
  data$edges <- data$edges %>%
    mutate(
      arrows = "to",
      color = "#848484",
      title = paste0("<b>", from, " → ", to, "</b><br>• <i>",  ## NOTE: this is hacky, use purrr::map_chr() or custom function
               gsub(";", "<br>• ", concepts), "</i>"),
      smooth = I(list(list(type = "curvedCCW", roundness = 0.2)))
    )
    
  return(data)
}

# --- 3. THE PLOTTER ---
#' Generate interactive network graph
#'
#' @param transformed_data A list containing processed nodes and edges.
#'
#' @return A visNetwork HTML widget object.
plot_knowledge_map <- function(transformed_data) {
  visNetwork(transformed_data$nodes, transformed_data$edges, width = "100%", height = "800px") %>%
    visPhysics(enabled = FALSE) %>% 
    visOptions(
      highlightNearest = list(enabled = TRUE, degree = 1, hover = TRUE),
      nodesIdSelection = TRUE
    ) %>%
    visInteraction(dragNodes = FALSE, zoomView = TRUE)
}

# --- EXECUTION ---
raw_data <- read_map_data("data/nodes.csv", "data/edges.csv")
ready_data <- transform_map_data(raw_data)
plot_knowledge_map(ready_data)
```

## 2 Block-wise Arrangement 

```{r}
#| echo: false
#| message: false
#| warning: false


# --- 2. THE TRANSFORMER 2 (Block-Based) ---
#' Converts block numbers into columns and auto-stacks nodes vertically.
#'
#' @param data A list containing 'nodes' and 'edges' data frames.
#' @return A list with modified data frames for the block-based view.
transform_map_data2 <- function(data) {
  data$nodes <- data$nodes %>%
    group_by(block) %>%
    mutate(
      x = block * 350,
      y = row_number() * 120,
      
      label = label,
      title = name,
      shape = "box",
      color = I(list(list(background = "#E8F5E9", border = "#4CAF50", highlight = "#FFB347"))),
      font = I(list(list(face = "Arial", size = 18))),
      shadow = TRUE,
      fixed = TRUE
    ) %>%
    ungroup()
  
  data$edges <- data$edges %>%
    mutate(
      arrows = "to",
      color = "#848484",
      title = paste0("<b>", from, " → ", to, "</b><br>• <i>", 
                     gsub(";", "<br>• ", concepts), "</i>"),
      smooth = I(list(list(type = "curvedCCW", roundness = 0.2)))
    )
    
  return(data)
}

# --- 3. THE PLOTTER 2 (Block-Based) ---
#' Generate the block-structured interactive graph.
#'
#' @param transformed_data A list containing processed nodes and edges.
#' @return A visNetwork HTML widget object.
plot_knowledge_map2 <- function(transformed_data) {
  visNetwork(transformed_data$nodes, transformed_data$edges, width = "100%", height = "600px") %>%
    visPhysics(enabled = FALSE) %>% 
    visOptions(highlightNearest = list(enabled = TRUE, hover = TRUE)) %>%
    visInteraction(dragNodes = FALSE, zoomView = TRUE)
}


# --- EXECUTION ---
ready_data_block <- transform_map_data2(raw_data)
plot_knowledge_map2(ready_data_block)
```